<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureP2P - –ó–∞—â–∏—â–µ–Ω–Ω—ã–π P2P —á–∞—Ç</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 10px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .status {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .disconnected {
            background: var(--danger);
        }

        .connecting {
            background: var(--warning);
        }

        .connected {
            background: #2ecc71;
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .panel {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .left-panel {
            background: var(--light);
            border-right: 1px solid var(--gray-light);
        }

        .right-panel {
            background: white;
        }

        h2 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.4rem;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #5a0a9c;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #3ab0d9;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #df8510;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c1121f;
        }

        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }

        .btn-icon {
            margin-right: 8px;
        }

        .config-section {
            margin-top: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .config-area {
            flex: 1;
            padding: 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            background: white;
            font-family: monospace;
            font-size: 0.85rem;
            resize: none;
            margin-bottom: 15px;
        }

        .config-area:focus {
            outline: none;
            border-color: var(--primary);
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            background: var(--light);
        }

        .message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message-them {
            background: white;
            border: 1px solid var(--gray-light);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message-me {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .input-group {
            display: flex;
            margin-top: auto;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            font-size: 1rem;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-btn {
            padding: 0 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            cursor: pointer;
            transition: var(--transition);
        }

        .send-btn:hover {
            background: var(--primary-dark);
        }

        .hidden {
            display: none !important;
        }

        .step {
            margin-bottom: 20px;
        }

        .step-number {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            margin-right: 10px;
        }

        .features {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .feature {
            flex: 1;
            min-width: 120px;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
        }

        .feature-icon {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .tab-container {
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-light);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            font-weight: 600;
        }

        .tab-content {
            padding: 20px 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .voice-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .voice-buttons .btn {
            flex: 1;
            min-width: 120px;
            margin-bottom: 0;
        }

        .audio-container {
            margin-top: 20px;
        }

        .volume-control {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .volume-control label {
            min-width: 80px;
        }

        .mic-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            border-radius: var(--border-radius);
            background: var(--light);
        }

        .mic-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .mic-on {
            background: #2ecc71;
        }

        .mic-off {
            background: var(--danger);
        }

        .connection-steps {
            margin-top: 20px;
        }

        .connection-step {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: var(--border-radius);
            background: white;
        }

        .step-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .step-active {
            background: var(--primary);
            color: white;
        }

        .step-completed {
            background: #2ecc71;
            color: white;
        }

        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }
            
            .left-panel {
                border-right: none;
                border-bottom: 1px solid var(--gray-light);
            }
            
            .container {
                height: auto;
                max-height: 90vh;
            }

            .voice-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SecureP2P</h1>
            <p>–ó–∞—â–∏—â–µ–Ω–Ω—ã–π P2P —á–∞—Ç –∏ –≥–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å —á–µ—Ä–µ–∑ WebRTC</p>
            <div class="status">
                <div class="status-dot disconnected" id="statusDot"></div>
                <span id="statusText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
            </div>
        </header>
        
        <main>
            <div class="panel left-panel">
                <h2>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h2>
                
                <div class="info-box">
                    –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –Ω–∏–∂–µ. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –º–µ–∂–¥—É –≤–∞–º–∏ –∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º.
                </div>
                
                <div id="connectionSetup">
                    <div class="step">
                        <span class="step-number">1</span>
                        <strong>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</strong>
                    </div>
                    
                    <button id="createBtn" class="btn btn-primary">
                        <span class="btn-icon">üîó</span> –°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    </button>
                    
                    <button id="joinBtn" class="btn btn-secondary">
                        <span class="btn-icon">üë•</span> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                    </button>
                    
                    <div class="connection-steps">
                        <div class="connection-step">
                            <div class="step-indicator" id="step1Indicator">1</div>
                            <div>
                                <strong>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</strong>
                                <div id="step1Text" class="step-text">–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                            </div>
                        </div>
                        <div class="connection-step">
                            <div class="step-indicator" id="step2Indicator">2</div>
                            <div>
                                <strong>–û–±–º–µ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π</strong>
                                <div id="step2Text" class="step-text">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É</div>
                            </div>
                        </div>
                        <div class="connection-step">
                            <div class="step-indicator" id="step3Indicator">3</div>
                            <div>
                                <strong>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</strong>
                                <div id="step3Text" class="step-text">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="configSection" class="config-section hidden">
                        <textarea id="configInput" class="config-area" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∑–¥–µ—Å—å..."></textarea>
                        <textarea id="configOutput" class="config-area" placeholder="–í–∞—à –∫–æ–Ω—Ñ–∏–≥ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..." readonly></textarea>
                        
                        <div class="config-buttons" style="display: flex; gap: 10px;">
                            <button id="useConfigBtn" class="btn btn-success" style="flex: 1;">
                                <span class="btn-icon">‚úÖ</span> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
                            </button>
                            
                            <button id="copyConfigBtn" class="btn btn-primary" style="flex: 1;">
                                <span class="btn-icon">üìã</span> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="features">
                    <div class="feature">
                        <div class="feature-icon">üîí</div>
                        <div>–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ</div>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">üåê</div>
                        <div>P2P</div>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">üöÄ</div>
                        <div>–ë—ã—Å—Ç—Ä–æ</div>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">üõ°Ô∏è</div>
                        <div>–ë–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞</div>
                    </div>
                </div>
            </div>
            
            <div class="panel right-panel">
                <div class="tab-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="chat">üí¨ –ß–∞—Ç</div>
                        <div class="tab" data-tab="voice">üé§ –ì–æ–ª–æ—Å</div>
                        <div class="tab" data-tab="info">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                    </div>
                    
                    <div class="tab-content">
                        <!-- –ß–∞—Ç -->
                        <div id="chat-tab" class="tab-pane active">
                            <h2>–ß–∞—Ç</h2>
                            <div class="chat-container">
                                <div id="messages" class="messages">
                                    <div class="message message-them">
                                        <div>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SecureP2P!</div>
                                        <div class="message-time">–°–∏—Å—Ç–µ–º–∞ ‚Ä¢ –¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                                    </div>
                                    <div class="message message-them">
                                        <div>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ.</div>
                                        <div class="message-time">–°–∏—Å—Ç–µ–º–∞ ‚Ä¢ –¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <input type="text" id="messageInput" class="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                                    <button id="sendBtn" class="send-btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ì–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å -->
                        <div id="voice-tab" class="tab-pane">
                            <h2>–ì–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å</h2>
                            <div class="info-box">
                                –ì–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.
                            </div>
                            
                            <div id="voiceControls" class="hidden">
                                <div class="voice-controls">
                                    <div class="voice-buttons">
                                        <button id="startVoiceBtn" class="btn btn-primary">
                                            <span class="btn-icon">üé§</span> –ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä
                                        </button>
                                        
                                        <button id="muteMicBtn" class="btn btn-warning hidden">
                                            <span class="btn-icon">üîá</span> –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
                                        </button>
                                        
                                        <button id="unmuteMicBtn" class="btn btn-success hidden">
                                            <span class="btn-icon">üé§</span> –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
                                        </button>
                                        
                                        <button id="endVoiceBtn" class="btn btn-danger hidden">
                                            <span class="btn-icon">üìµ</span> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä
                                        </button>
                                    </div>
                                    
                                    <div id="micStatus" class="mic-status hidden">
                                        <div class="mic-status-dot mic-off" id="micStatusDot"></div>
                                        <span id="micStatusText">–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω</span>
                                    </div>
                                    
                                    <div class="audio-container">
                                        <audio id="remoteAudio" controls></audio>
                                    </div>
                                    
                                    <div class="volume-control">
                                        <label for="volumeSlider">–ì—Ä–æ–º–∫–æ—Å—Ç—å:</label>
                                        <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div id="info-tab" class="tab-pane">
                            <h2>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h2>
                            <div class="info-box">
                                SecureP2P –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é WebRTC –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä—è–º–æ–≥–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –º–µ–∂–¥—É –±—Ä–∞—É–∑–µ—Ä–∞–º–∏.
                            </div>
                            
                            <h3 style="margin-top: 20px;">–®–∞–≥–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</h3>
                            <ol style="margin-left: 20px; margin-top: 10px;">
                                <li>–û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥</li>
                                <li>–ö–æ–Ω—Ñ–∏–≥ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤—Ç–æ—Ä–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º, —á–µ—Ä–µ–∑ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –∏ —Ç.–¥.)</li>
                                <li>–í—Ç–æ—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥ –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥</li>
                                <li>–û—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø–µ—Ä–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</li>
                                <li>–ü—Ä—è–º–æ–µ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                            </ol>
                            
                            <h3 style="margin-top: 20px;">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</h3>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li>–ü–æ–ª–Ω–∞—è –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è - –Ω–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞</li>
                                <li>–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã</li>
                                <li>–ü—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏</li>
                                <li>–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å - –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∏–≥–¥–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let peerConnection;
        let dataChannel;
        let localStream;
        let remoteStream;
        let isCaller = false;
        let isVoiceActive = false;
        let isMicMuted = false;
        let connectionSteps = {
            step1: { indicator: null, text: null },
            step2: { indicator: null, text: null },
            step3: { indicator: null, text: null }
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const configSection = document.getElementById('configSection');
        const configInput = document.getElementById('configInput');
        const configOutput = document.getElementById('configOutput');
        const useConfigBtn = document.getElementById('useConfigBtn');
        const copyConfigBtn = document.getElementById('copyConfigBtn');
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const startVoiceBtn = document.getElementById('startVoiceBtn');
        const muteMicBtn = document.getElementById('muteMicBtn');
        const unmuteMicBtn = document.getElementById('unmuteMicBtn');
        const endVoiceBtn = document.getElementById('endVoiceBtn');
        const remoteAudio = document.getElementById('remoteAudio');
        const volumeSlider = document.getElementById('volumeSlider');
        const voiceControls = document.getElementById('voiceControls');
        const micStatus = document.getElementById('micStatus');
        const micStatusDot = document.getElementById('micStatusDot');
        const micStatusText = document.getElementById('micStatusText');
        const tabs = document.querySelectorAll('.tab');
        const tabPanes = document.querySelectorAll('.tab-pane');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∞–≥–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        connectionSteps.step1.indicator = document.getElementById('step1Indicator');
        connectionSteps.step1.text = document.getElementById('step1Text');
        connectionSteps.step2.indicator = document.getElementById('step2Indicator');
        connectionSteps.step2.text = document.getElementById('step2Text');
        connectionSteps.step3.indicator = document.getElementById('step3Indicator');
        connectionSteps.step3.text = document.getElementById('step3Text');

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª–∞–¥–æ–∫
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                tabs.forEach(t => t.classList.remove('active'));
                tabPanes.forEach(p => p.classList.remove('active'));
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç—É
                tab.classList.add('active');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞–≥–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateConnectionStep(step, status) {
            const stepInfo = connectionSteps[step];
            if (!stepInfo) return;
            
            stepInfo.indicator.classList.remove('step-active', 'step-completed');
            
            if (status === 'active') {
                stepInfo.indicator.classList.add('step-active');
            } else if (status === 'completed') {
                stepInfo.indicator.classList.add('step-completed');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1)
        createBtn.addEventListener('click', async () => {
            isCaller = true;
            createBtn.disabled = true;
            joinBtn.disabled = true;
            configSection.classList.remove('hidden');
            
            updateStatus('connecting', '–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...');
            updateConnectionStep('step1', 'active');
            connectionSteps.step1.text.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...';
            
            try {
                // –°–æ–∑–¥–∞–µ–º RTCPeerConnection —Å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ],
                    iceCandidatePoolSize: 10
                });
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // –ö–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    } else {
                        // –í—Å–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å–æ–±—Ä–∞–Ω—ã, –º–æ–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥
                        if (isCaller) {
                            configOutput.value = JSON.stringify(peerConnection.localDescription);
                            updateConnectionStep('step1', 'completed');
                            updateConnectionStep('step2', 'active');
                            connectionSteps.step2.text.textContent = '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É';
                            addSystemMessage('–ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.');
                        }
                    }
                };
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
                dataChannel = peerConnection.createDataChannel('chat', {
                    ordered: true
                });
                
                setupDataChannel(dataChannel);
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —É–∂–µ —Å–æ–±—Ä–∞–Ω—ã, —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥
                if (peerConnection.iceGatheringState === 'complete') {
                    configOutput.value = JSON.stringify(peerConnection.localDescription);
                    updateConnectionStep('step1', 'completed');
                    updateConnectionStep('step2', 'active');
                    connectionSteps.step2.text.textContent = '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É';
                    addSystemMessage('–ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:', error);
                addSystemMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
                resetConnection();
            }
        });

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2)
        joinBtn.addEventListener('click', () => {
            isCaller = false;
            createBtn.disabled = true;
            joinBtn.disabled = true;
            configSection.classList.remove('hidden');
            
            updateStatus('connecting', '–û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');
            updateConnectionStep('step1', 'active');
            connectionSteps.step1.text.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞';
            addSystemMessage('–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥".');
        });

        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        useConfigBtn.addEventListener('click', async () => {
            if (!configInput.value.trim()) {
                alert('–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
                return;
            }
            
            try {
                const config = JSON.parse(configInput.value);
                
                if (!peerConnection) {
                    peerConnection = new RTCPeerConnection({
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' }
                        ],
                        iceCandidatePoolSize: 10
                    });
                    
                    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            // –ö–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                        } else {
                            // –í—Å–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å–æ–±—Ä–∞–Ω—ã, –º–æ–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥
                            if (!isCaller) {
                                configOutput.value = JSON.stringify(peerConnection.localDescription);
                                updateConnectionStep('step2', 'completed');
                                updateConnectionStep('step3', 'active');
                                connectionSteps.step3.text.textContent = '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É';
                                addSystemMessage('–û—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.');
                            }
                        }
                    };
                    
                    // –û–∂–∏–¥–∞–µ–º –∫–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    peerConnection.ondatachannel = (event) => {
                        dataChannel = event.channel;
                        setupDataChannel(dataChannel);
                    };
                }
                
                if (config.type === 'offer') {
                    await peerConnection.setRemoteDescription(config);
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    updateConnectionStep('step1', 'completed');
                    connectionSteps.step1.text.textContent = '–ö–æ–Ω—Ñ–∏–≥ –ø—Ä–∏–Ω—è—Ç';
                    
                    // –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —É–∂–µ —Å–æ–±—Ä–∞–Ω—ã, —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥
                    if (peerConnection.iceGatheringState === 'complete') {
                        configOutput.value = JSON.stringify(peerConnection.localDescription);
                        updateConnectionStep('step2', 'completed');
                        updateConnectionStep('step3', 'active');
                        connectionSteps.step3.text.textContent = '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É';
                        addSystemMessage('–û—Ç–≤–µ—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.');
                    }
                    
                } else if (config.type === 'answer') {
                    await peerConnection.setRemoteDescription(config);
                    updateConnectionStep('step3', 'completed');
                    connectionSteps.step3.text.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                    addSystemMessage('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è.');
                    startChat();
                    showVoiceControls();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞:', error);
                addSystemMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞: ' + error.message);
            }
        });

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        copyConfigBtn.addEventListener('click', () => {
            if (!configOutput.value.trim()) {
                alert('–ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            configOutput.select();
            document.execCommand('copy');
            addSystemMessage('–ö–æ–Ω—Ñ–∏–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.');
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–Ω–∞–ª–∞ –¥–∞–Ω–Ω—ã—Ö
        function setupDataChannel(channel) {
            channel.onopen = () => {
                console.log('–ö–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç!');
                updateStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
                updateConnectionStep('step3', 'completed');
                connectionSteps.step3.text.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                addSystemMessage('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è.');
                startChat();
                showVoiceControls();
            };
            
            channel.onclose = () => {
                console.log('–ö–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç');
                updateStatus('disconnected', '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
                addSystemMessage('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ.');
                resetConnection();
            };
            
            channel.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'message') {
                        addMessage(data.content, false);
                    } else if (data.type === 'system') {
                        addSystemMessage(data.content);
                    } else if (data.type === 'voice-status') {
                        if (data.micMuted !== undefined) {
                            updateRemoteMicStatus(data.micMuted);
                        }
                    }
                } catch (e) {
                    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ JSON, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    addMessage(event.data, false);
                }
            };
        }

        // –ó–∞–ø—É—Å–∫ —á–∞—Ç–∞
        function startChat() {
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–π —Å–≤—è–∑—å—é
        function showVoiceControls() {
            voiceControls.classList.remove('hidden');
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && dataChannel && dataChannel.readyState === 'open') {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ JSON –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
                dataChannel.send(JSON.stringify({
                    type: 'message',
                    content: message,
                    timestamp: new Date().toISOString()
                }));
                
                addMessage(message, true);
                messageInput.value = '';
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessage(text, isMe) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isMe ? 'message-me' : 'message-them'}`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageElement.innerHTML = `
                <div>${text}</div>
                <div class="message-time">${isMe ? '–í—ã' : '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'} ‚Ä¢ ${time}</div>
            `;
            
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function addSystemMessage(text) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message message-them';
            
            messageElement.innerHTML = `
                <div>${text}</div>
                <div class="message-time">–°–∏—Å—Ç–µ–º–∞ ‚Ä¢ ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateStatus(status, text) {
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        function updateMicStatus(muted) {
            isMicMuted = muted;
            
            if (muted) {
                micStatusDot.className = 'mic-status-dot mic-off';
                micStatusText.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω';
                muteMicBtn.classList.add('hidden');
                unmuteMicBtn.classList.remove('hidden');
            } else {
                micStatusDot.className = 'mic-status-dot mic-on';
                micStatusText.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω';
                muteMicBtn.classList.remove('hidden');
                unmuteMicBtn.classList.add('hidden');
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(JSON.stringify({
                    type: 'voice-status',
                    micMuted: muted
                }));
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
        function updateRemoteMicStatus(muted) {
            if (muted) {
                addSystemMessage('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤—ã–∫–ª—é—á–∏–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω');
            } else {
                addSystemMessage('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤–∫–ª—é—á–∏–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω');
            }
        }

        // –°–±—Ä–æ—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function resetConnection() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            dataChannel = null;
            createBtn.disabled = false;
            joinBtn.disabled = false;
            configSection.classList.add('hidden');
            configInput.value = '';
            configOutput.value = '';
            messageInput.disabled = true;
            sendBtn.disabled = true;
            voiceControls.classList.add('hidden');
            micStatus.classList.add('hidden');
            
            // –°–±—Ä–æ—Å —à–∞–≥–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            updateConnectionStep('step1', '');
            updateConnectionStep('step2', '');
            updateConnectionStep('step3', '');
            connectionSteps.step1.text.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
            connectionSteps.step2.text.textContent = '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É';
            connectionSteps.step3.text.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è';
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            isVoiceActive = false;
            updateStatus('disconnected', '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
        }

        // –ì–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å
        startVoiceBtn.addEventListener('click', async () => {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
                peerConnection.ontrack = (event) => {
                    remoteStream = event.streams[0];
                    remoteAudio.srcObject = remoteStream;
                };
                
                startVoiceBtn.classList.add('hidden');
                muteMicBtn.classList.remove('hidden');
                endVoiceBtn.classList.remove('hidden');
                micStatus.classList.remove('hidden');
                
                isVoiceActive = true;
                updateMicStatus(false);
                
                addSystemMessage('–ì–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                addSystemMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + error.message);
            }
        });

        // –í—ã–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        muteMicBtn.addEventListener('click', () => {
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = false;
                });
                
                updateMicStatus(true);
                addSystemMessage('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω.');
            }
        });

        // –í–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        unmuteMicBtn.addEventListener('click', () => {
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = true;
                });
                
                updateMicStatus(false);
                addSystemMessage('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω.');
            }
        });

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–π —Å–≤—è–∑–∏
        endVoiceBtn.addEventListener('click', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            remoteAudio.srcObject = null;
            
            startVoiceBtn.classList.remove('hidden');
            muteMicBtn.classList.add('hidden');
            unmuteMicBtn.classList.add('hidden');
            endVoiceBtn.classList.add('hidden');
            micStatus.classList.add('hidden');
            
            isVoiceActive = false;
            updateMicStatus(false);
            
            addSystemMessage('–ì–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞.');
        });

        // –†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        volumeSlider.addEventListener('input', () => {
            if (remoteAudio) {
                remoteAudio.volume = volumeSlider.value;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (peerConnection) {
                peerConnection.close();
            }
        });
    </script>
</body>
</html>
